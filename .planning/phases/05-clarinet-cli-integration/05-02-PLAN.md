---
phase: 05-clarinet-cli-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [skills/stacks-dev/SKILL.md]
autonomous: true

must_haves:
  truths:
    - "Skill detects and initializes Clarinet project structure when missing"
    - "Skill automatically runs clarinet check after contract modifications"
    - "Skill guides devnet startup before frontend phase"
    - "Skill applies deployment safety gates based on target network"
    - "Skill provides console commands for interactive testing"
  artifacts:
    - path: "skills/stacks-dev/SKILL.md"
      provides: "Workflow phases with integrated CLI orchestration"
      max_lines: 600
      contains:
        - "clarinet check"
        - "devnet"
        - "deployment"
        - "Clarinet.toml"
  key_links:
    - from: "skills/stacks-dev/SKILL.md"
      to: "references/clarity-cli.md"
      via: "Reference loading"
      pattern: "clarity-cli\\.md"
---

<objective>
Update SKILL.md workflow phases to integrate Clarinet CLI orchestration including project initialization detection, automatic validation after edits, devnet workflow before frontend phase, and deployment safety gates.

Purpose: Make the skill actively guide CLI operations throughout the development workflow, not just reference commands passively.

Output: Updated SKILL.md with CLI integration woven into existing phases (staying under 600 lines).
</objective>

<execution_context>
@/Users/kenny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kenny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-clarinet-cli-integration/05-RESEARCH.md
@.planning/phases/05-clarinet-cli-integration/05-CONTEXT.md
@skills/stacks-dev/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Project Initialization to Phase 1 (Design)</name>
  <files>skills/stacks-dev/SKILL.md</files>
  <action>
Update Phase 1/5: Design section in SKILL.md to include project initialization:

1. **Add "Project Setup" subsection** before "Steps":
   - Detection: Check if Clarinet.toml exists in current directory
   - If missing: Offer to run `clarinet new <project-name>`
   - If exists: Acknowledge existing project, skip initialization
   - If found but user wants fresh start: Warn about overwrite, require confirmation

2. **Add CLI verification**:
   - Check if Clarinet is installed before first command
   - If missing: Provide installation instructions (brew, download, winget)
   - Verify with `clarinet --version`

3. **Update verification checklist** to include:
   - [ ] Clarinet project initialized (Clarinet.toml exists)
   - [ ] Project structure valid (contracts/, tests/, settings/ directories)

Keep additions concise (10-15 lines). Reference clarity-cli.md for detailed command patterns.
  </action>
  <verify>
Grep for "Project Setup" and "Clarinet.toml" in SKILL.md Phase 1 section
  </verify>
  <done>
Phase 1 includes project initialization detection and Clarinet installation verification
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Automatic Validation to Phase 2-3</name>
  <files>skills/stacks-dev/SKILL.md</files>
  <action>
Update Phase 2 and Phase 3 sections in SKILL.md to include automatic validation:

**Phase 2 (Tests):**
1. Add to Step 1 (Create Contract Scaffold):
   - After `clarinet contract new`, run `clarinet check` automatically
   - Confirm both contract and test files created

2. Update verification to include:
   - [ ] `clarinet check` passes (contract syntax valid)

**Phase 3 (Implementation):**
1. Add "Automatic Validation" subsection after Steps:
   - After every contract edit, automatically run `clarinet check`
   - If errors found: Parse and display in readable format
   - Auto-fix simple errors (unnecessary begin, unwrap-panic)
   - Escalate complex errors with explanation
   - Maximum 3 auto-fix attempts before asking user

2. Add error handling behavior:
   ```
   After each edit:
   1. Run `clarinet check`
   2. If pass: Continue to tests
   3. If fail: Parse errors → auto-fix (up to 3x) → escalate
   ```

3. Update verification to include:
   - [ ] `clarinet check` passes after all edits

Keep additions concise. Reference clarity-cli.md for error patterns.
  </action>
  <verify>
Grep for "Automatic Validation" and "clarinet check" in SKILL.md Phase 2-3 sections
  </verify>
  <done>
Phase 2-3 include automatic `clarinet check` after edits with error handling workflow
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Devnet Workflow and Deployment Safety to Phase 5 (Frontend)</name>
  <files>skills/stacks-dev/SKILL.md</files>
  <action>
Update Phase 5/5: Frontend section in SKILL.md to include devnet and deployment workflow:

1. **Restructure Phase 5 Steps** to be more sequential:

   **Pre-Frontend Setup:**
   - Check Docker is running (required for devnet)
   - Suggest starting devnet in dedicated terminal (not background)
   - Wait for health check (node responding at localhost:20443)
   - Deploy contracts to devnet (auto-deploy, no confirmation needed)

   **Frontend Development:**
   - Connect wallet with @stacks/connect
   - Call contracts with @stacks/transactions
   - Handle results and errors

   **Deployment Options:**
   - Stay on devnet (default)
   - Deploy to testnet (requires confirmation, shows plan first)
   - Deploy to mainnet (requires explicit confirmation, shows costs)

2. **Add "Devnet Lifecycle" subsection**:
   - Starting: Run `clarinet devnet start` in separate terminal
   - Health check: Wait for node to respond
   - Ending session: Remind to run `clarinet devnet stop`

3. **Add "Deployment Safety" subsection**:
   - Devnet: Auto-deploy without confirmation
   - Testnet/Mainnet: Show plan → confirm → deploy → verify on-chain
   - Network switching: Always confirm when moving to higher tier

4. **Add "Console Testing" subsection**:
   - Provide example console commands for interactive testing
   - List common commands (contract-call?, ::set_tx_sender, ::mint_stx)
   - Note: Console is for manual exploration, not automated

5. **Update verification checklist**:
   - [ ] Devnet started and healthy
   - [ ] Contracts deployed to devnet
   - [ ] (Optional) Deployed to testnet/mainnet with verification

Keep total additions to ~30-40 lines. Reference clarity-cli.md for detailed patterns.
  </action>
  <verify>
Grep for "Devnet Lifecycle", "Deployment Safety", and "Console Testing" in SKILL.md Phase 5 section
  </verify>
  <done>
Phase 5 includes devnet workflow, deployment safety tiers, and console testing guidance
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. `wc -l skills/stacks-dev/SKILL.md` shows file under 600 lines
2. All five CLAR requirements addressed:
   - CLAR-01: Project setup with clarinet new/contract new (Phase 1)
   - CLAR-02: clarinet check after modifications (Phase 2-3)
   - CLAR-03: Console commands for interactive testing (Phase 5)
   - CLAR-04: Devnet workflow with health check (Phase 5)
   - CLAR-05: Deployment with tiered safety (Phase 5)
3. Reference links to clarity-cli.md preserved
4. Existing phase content not disrupted (TDD workflow, coverage gates still work)
</verification>

<success_criteria>
- Phase 1 detects/initializes Clarinet project structure
- Phases 2-3 automatically run clarinet check after edits
- Phase 5 includes devnet startup and health check workflow
- Phase 5 applies tiered deployment safety (devnet auto, testnet/mainnet confirm)
- Phase 5 provides console command examples
- SKILL.md stays under 600 lines total
- All existing functionality preserved (TDD tracking, coverage gates, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/05-clarinet-cli-integration/05-02-SUMMARY.md`
</output>
