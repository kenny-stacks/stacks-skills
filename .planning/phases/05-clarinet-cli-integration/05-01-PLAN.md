---
phase: 05-clarinet-cli-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [skills/stacks-dev/references/clarity-cli.md]
autonomous: true

must_haves:
  truths:
    - "Skill knows which commands to auto-execute vs require confirmation"
    - "Skill can interpret clarinet check errors and suggest fixes"
    - "Skill guides devnet lifecycle (start in separate terminal, health check, stop reminder)"
    - "Skill applies tiered deployment safety (devnet auto, testnet/mainnet confirm)"
    - "Skill provides console command examples for interactive testing"
  artifacts:
    - path: "skills/stacks-dev/references/clarity-cli.md"
      provides: "CLI orchestration reference with command automation, error handling, devnet lifecycle, deployment safety"
      min_lines: 280
      contains:
        - "Command Automation"
        - "Error Handling"
        - "Devnet Lifecycle"
        - "Deployment Safety"
        - "Console Commands"
  key_links:
    - from: "skills/stacks-dev/SKILL.md"
      to: "references/clarity-cli.md"
      via: "Phase references"
      pattern: "clarity-cli\\.md"
---

<objective>
Enhance clarity-cli.md reference file with CLI orchestration guidance covering command automation patterns, error interpretation, devnet lifecycle management, deployment safety tiers, and console command examples.

Purpose: Provide the reference content that SKILL.md phases will load when executing CLI operations. This file becomes the source of truth for how the skill interacts with Clarinet CLI.

Output: Enhanced clarity-cli.md (~280+ lines) with five new sections covering all CLAR requirements.
</objective>

<execution_context>
@/Users/kenny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kenny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-clarinet-cli-integration/05-RESEARCH.md
@.planning/phases/05-clarinet-cli-integration/05-CONTEXT.md
@skills/stacks-dev/references/clarity-cli.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Command Automation Section</name>
  <files>skills/stacks-dev/references/clarity-cli.md</files>
  <action>
Add a "Command Automation" section to clarity-cli.md covering:

1. **Auto-Execute Commands** (run without confirmation):
   - `clarinet check` - Always auto-run after edits
   - `clarinet test` - Auto-run for test execution
   - `clarinet contract new <name>` - Auto-run, just confirm creation
   - `clarinet deployments generate --devnet` - Auto-run for devnet plans
   - `clarinet deployments apply --devnet` - Auto-run for devnet deployments

2. **Confirmation Required** (destructive/significant):
   - `clarinet new <name>` - Warn if Clarinet.toml exists, confirm overwrite
   - `clarinet devnet start` - Suggest dedicated terminal (not auto-background)
   - `clarinet deployments apply --testnet/--mainnet` - Always confirm
   - Network switching (testnet to mainnet) - Always confirm

3. **Detection Patterns**:
   - Check for existing Clarinet.toml before `clarinet new`
   - Check for Clarinet installation before first CLI command
   - Check for Docker before devnet commands

Include example decision tree for common scenarios.
  </action>
  <verify>
Grep for "Command Automation" section header and "Auto-Execute" subsection in clarity-cli.md
  </verify>
  <done>
clarity-cli.md has Command Automation section with auto-execute list, confirmation-required list, and detection patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Error Handling Section</name>
  <files>skills/stacks-dev/references/clarity-cli.md</files>
  <action>
Add an "Error Handling" section to clarity-cli.md covering:

1. **Error Interpretation**:
   - Parse `clarinet check` output for file, line, column, message
   - Common error types: syntax, type, analysis, undefined reference
   - User-friendly error summaries (not raw output pass-through)

2. **Auto-Fix Patterns** (mechanical fixes, apply automatically):
   - Unnecessary begin blocks - Remove wrapper, keep content
   - unwrap-panic usage - Replace with unwrap! and suggest error code
   - Missing semicolons or syntax issues - Fix obvious typos

3. **Manual Intervention** (explain, don't auto-fix):
   - Type mismatches requiring signature changes
   - Undefined references requiring new definitions
   - Logic errors in conditionals

4. **Auto-Fix Loop**:
   - Maximum 3 attempts
   - Re-run `clarinet check` after each fix
   - Escalate to user with explanation after 3 failures

Include example error output and interpreted format.
  </action>
  <verify>
Grep for "Error Handling" section header and "Auto-Fix Patterns" subsection in clarity-cli.md
  </verify>
  <done>
clarity-cli.md has Error Handling section with error interpretation, auto-fix patterns, manual intervention guidance, and 3-attempt loop
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Devnet Lifecycle and Deployment Safety Sections</name>
  <files>skills/stacks-dev/references/clarity-cli.md</files>
  <action>
Add "Devnet Lifecycle" and "Deployment Safety" sections to clarity-cli.md:

**Devnet Lifecycle:**
1. **Prerequisites**:
   - Check Docker is running before devnet commands
   - Installation instructions if Docker not found

2. **Starting Devnet**:
   - Suggest dedicated terminal (keep logs visible)
   - Not background process (user loses logs)
   - Provide exact command: `clarinet devnet start`

3. **Health Check**:
   - Query `localhost:20443/v2/info` for node status
   - Wait for stacks_tip_height > 0 (node ready)
   - Timeout after 60 seconds with troubleshooting guidance

4. **Session End**:
   - Always remind user to stop devnet
   - Provide command: `clarinet devnet stop`

**Deployment Safety:**
1. **Tiered Approach**:
   | Network | Confirmation | Dry-Run | On-Chain Verify |
   |---------|--------------|---------|-----------------|
   | Devnet  | No           | No      | No (trust output) |
   | Testnet | Yes          | Yes     | Yes             |
   | Mainnet | Yes (explicit) | Yes   | Yes             |

2. **Testnet/Mainnet Workflow**:
   - Generate deployment plan first
   - Show plan summary (contracts, fees, deployer)
   - Request explicit confirmation
   - Apply deployment
   - Verify contract exists on-chain via Stacks API

3. **Network Switching**:
   - Always confirm when switching from lower to higher tier
   - Show current network in prompts

Include health check script example and API verification example.
  </action>
  <verify>
Grep for "Devnet Lifecycle" and "Deployment Safety" section headers in clarity-cli.md
  </verify>
  <done>
clarity-cli.md has Devnet Lifecycle section with prerequisites, starting, health check, session end; and Deployment Safety section with tiered approach and verification workflow
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. `grep -c "## " skills/stacks-dev/references/clarity-cli.md` shows increased section count
2. All five major sections exist: Command Automation, Error Handling, Devnet Lifecycle, Deployment Safety, Console Commands
3. File stays under 400 lines (reference file limit per project conventions)
4. External reference links preserved and functional
</verification>

<success_criteria>
- clarity-cli.md enhanced with CLI orchestration guidance
- Command automation patterns documented (auto-execute vs confirm)
- Error handling workflow documented (parse, auto-fix, escalate)
- Devnet lifecycle documented (Docker check, dedicated terminal, health check, stop reminder)
- Deployment safety tiers documented (devnet auto, testnet/mainnet confirm+verify)
- Console command examples provided for interactive testing
- File is ~280-400 lines (expanded but within reference file limits)
</success_criteria>

<output>
After completion, create `.planning/phases/05-clarinet-cli-integration/05-01-SUMMARY.md`
</output>
