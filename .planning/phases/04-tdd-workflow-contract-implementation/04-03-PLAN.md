---
phase: 04-tdd-workflow-contract-implementation
plan: 03
type: execute
wave: 2
depends_on:
  - "04-01"
  - "04-02"
files_modified:
  - skills/stacks-dev/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Phase 2 (Tests) includes collaborative test scenario workflow"
    - "Phase 3 (Implementation) references clarity-implementation.md for best practices"
    - "Phase 4 (Verification) shows coverage after every test run"
    - "TDD compliance tracking displays status (followed/skipped)"
    - "90% coverage gate has user override option"
  artifacts:
    - path: "skills/stacks-dev/SKILL.md"
      provides: "Updated workflow orchestration with TDD enforcement"
      contains: "Collaborative Test Generation"
      min_lines: 400
  key_links:
    - from: "SKILL.md Phase 2"
      to: "clarity-tdd.md"
      via: "reference link"
      pattern: "references/clarity-tdd.md"
    - from: "SKILL.md Phase 3"
      to: "clarity-implementation.md"
      via: "reference link"
      pattern: "references/clarity-implementation.md"
---

<objective>
Update SKILL.md workflow phases with collaborative TDD workflow, best practices review, and coverage enforcement.

Purpose: Integrate Phase 4 requirements into the main skill file, connecting phases 2-4 with the enhanced reference files.

Output: Updated SKILL.md with:
- Phase 2: Collaborative test scenario workflow
- Phase 3: Best practices review with auto-fix
- Phase 4: Coverage display and gate override
- TDD compliance tracking
</objective>

<execution_context>
@/Users/kenny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kenny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context with locked decisions
@.planning/phases/04-tdd-workflow-contract-implementation/04-CONTEXT.md
@.planning/phases/04-tdd-workflow-contract-implementation/04-RESEARCH.md

# Previous plan summaries for reference file locations
@.planning/phases/04-tdd-workflow-contract-implementation/04-01-SUMMARY.md
@.planning/phases/04-tdd-workflow-contract-implementation/04-02-SUMMARY.md

# Current SKILL.md to update
@skills/stacks-dev/SKILL.md

# New reference files to link
@skills/stacks-dev/references/clarity-tdd.md
@skills/stacks-dev/references/clarity-implementation.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Phases 2-3 with collaborative workflow and best practices</name>
  <files>skills/stacks-dev/SKILL.md</files>
  <action>
Update Phase 2/5: Tests and Phase 3/5: Implementation sections in SKILL.md:

## Phase 2 Updates:

1. Add TDD compliance status to Phase 2 header:
```markdown
## Phase 2/5: Tests
**TDD Status:** [✓ followed | ⚠ skipped]
```

2. Add new subsection "### Collaborative Test Generation" before Steps:
```markdown
### Collaborative Test Generation

I'll propose test scenarios organized by category:

**Happy Path:**
- [Scenario description with expected outcome]

**Edge Cases:**
- [Zero/boundary values, empty inputs]

**Error Handling:**
- [Authorization failures, validation errors]

Review and approve the scenarios. After approval, I'll write all test code in batch.
```

3. Update Steps section to reflect collaborative workflow:
- Step 1: Create contract scaffold (unchanged)
- Step 2: I propose test scenarios based on design doc
- Step 3: You review and approve scenarios
- Step 4: I write test files implementing approved scenarios
- Step 5: Run tests (should fail - RED phase)

4. Add soft TDD enforcement note:
```markdown
### TDD Compliance

If you request contract code before tests exist, I'll gently redirect:
"Following TDD, let's write tests first. This helps catch edge cases early."

If you prefer to proceed anyway, I'll continue and track the workflow:
- **TDD: ✓ followed** - Tests written before implementation
- **TDD: ⚠ skipped** - Contract written before tests (increased coverage threshold)
```

5. Update verification checklist and reference link to enhanced clarity-tdd.md

## Phase 3 Updates:

1. Add TDD compliance status to Phase 3 header:
```markdown
## Phase 3/5: Implementation
**TDD Status:** [✓ followed | ⚠ skipped]
```

2. Add new subsection "### Best Practices Review" after Steps:
```markdown
### Best Practices Review

After each function, I'll review for Clarity best practices:

**Coding Style:**
- Sequential asserts instead of nested if
- Meaningful error codes (HTTP-like: 400, 401, 404)
- No unnecessary begin blocks
- No unwrap-panic (use unwrap! with error codes)

**Storage:**
- Hash storage for large data
- Minimal on-chain storage
- Efficient map usage

**Upgradability:**
- Dynamic principals for upgradable references
- Data/logic separation where appropriate

I'll auto-fix mechanical violations (unnecessary begin, unwrap-panic) and explain what changed.
For structural changes (nested if → asserts), I'll ask first.
```

3. Add `clarinet check` automation note and reference link to clarity-implementation.md
  </action>
  <verify>
Phases 2-3 updated:
```bash
grep -A5 "Collaborative Test Generation" skills/stacks-dev/SKILL.md
grep "TDD Compliance" skills/stacks-dev/SKILL.md
grep "TDD Status" skills/stacks-dev/SKILL.md
grep -A5 "Best Practices Review" skills/stacks-dev/SKILL.md
grep "clarity-implementation.md" skills/stacks-dev/SKILL.md
```
  </verify>
  <done>
Phase 2 includes collaborative test generation, TDD compliance with header status display.
Phase 3 includes best practices review, auto-fix workflow, and TDD status in header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Phase 4 (Verification) with coverage workflow and TDD tracking</name>
  <files>skills/stacks-dev/SKILL.md</files>
  <action>
Update Phase 4/5: Verification section in SKILL.md:

1. Add TDD compliance status to Phase 4 header:
```markdown
## Phase 4/5: Verification
**TDD Status:** [✓ followed | ⚠ skipped - 95% coverage required]
```

2. Fix the coverage command (CRITICAL - deprecated syntax):
Replace any `clarinet test --coverage` with `npm run test:coverage` (which runs `vitest run --coverage`)

3. Add coverage display after every test run:
```markdown
### Coverage Display

After every test run, I'll show coverage status:

```
Coverage: 87% (target: 90%)
├── Lines: 87%
├── Functions: 100%
├── Branches: 75%
└── Statements: 88%

Uncovered:
- transfer() line 45: zero-amount validation branch
- admin-set-fee() lines 67-70: entire function
```
```

4. Update coverage gap analysis:
```markdown
### Coverage Gap Analysis

When below 90%, I'll identify specific gaps and suggest tests:

"Line 45 is the zero-amount check in transfer().
Suggested test: 'should reject transfer with zero amount → ERR-INVALID-AMOUNT'"

Accept suggestions or provide your own test scenarios.
```

5. Add user override for 90% gate:
```markdown
### Coverage Gate Override

**Standard threshold:** 90%

If coverage is below 90% and you want to proceed anyway:
- Say "proceed anyway" or "skip coverage gate"
- I'll note the override and continue to Phase 5
- No justification required

**If TDD was skipped:** Threshold increases to 95%
```

6. Update verification checklist:
- [ ] Coverage >= 90% (or 95% if TDD skipped)
- [ ] All functions tested
- [ ] Uncovered lines identified with suggested tests
- [ ] Security review completed
  </action>
  <verify>
Phase 4 updated with correct coverage command and TDD status:
```bash
grep "npm run test:coverage" skills/stacks-dev/SKILL.md
grep "TDD Status" skills/stacks-dev/SKILL.md
grep "proceed anyway" skills/stacks-dev/SKILL.md
grep "95%" skills/stacks-dev/SKILL.md
grep -A10 "Coverage Display" skills/stacks-dev/SKILL.md
```
  </verify>
  <done>
Phase 4 uses correct Vitest coverage command, displays TDD status in header, shows coverage after every run, and includes override option with 95% threshold when TDD skipped.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. SKILL.md still under 500 lines: `wc -l skills/stacks-dev/SKILL.md`
2. Phase 2 has collaborative test generation
3. Phase 3 references clarity-implementation.md
4. Phase 4 uses vitest/npm coverage (not deprecated clarinet test --coverage)
5. TDD compliance tracking exists
6. Coverage gate override exists
7. skills-ref validate passes: `npx skills-ref validate ./skills/stacks-dev`
</verification>

<success_criteria>
1. SKILL.md Phase 2 includes "Collaborative Test Generation" section with scenario categories
2. SKILL.md Phase 2 includes "TDD Compliance" section with tracking display
3. SKILL.md Phase 3 includes "Best Practices Review" section with auto-fix behavior
4. SKILL.md Phase 3 links to clarity-implementation.md reference
5. SKILL.md Phase 4 uses `npm run test:coverage` (Vitest-based)
6. SKILL.md Phase 4 includes "Coverage Display" section showing after every run
7. SKILL.md Phase 4 includes "Coverage Gate Override" section with user override
8. SKILL.md Phase 4 notes 95% threshold when TDD skipped
9. SKILL.md stays under 500 lines
10. skills-ref validate passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-tdd-workflow-contract-implementation/04-03-SUMMARY.md`
</output>
