---
phase: 04-tdd-workflow-contract-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/stacks-dev/references/clarity-tdd.md
autonomous: true

must_haves:
  truths:
    - "Reference file documents collaborative TDD workflow (propose scenarios → approve → write tests)"
    - "Reference file includes Vitest + Clarinet SDK patterns with simnet API"
    - "Reference file shows coverage configuration with 90% thresholds"
    - "Reference file explains soft TDD enforcement with tracking"
  artifacts:
    - path: "skills/stacks-dev/references/clarity-tdd.md"
      provides: "Comprehensive TDD reference for Phase 2"
      contains: "Collaborative Test Scenario Approval"
      min_lines: 180
  key_links:
    - from: "clarity-tdd.md"
      to: "Vitest + Clarinet SDK"
      via: "code examples"
      pattern: "vitest|simnet|toBeOk|toBeErr"
---

<objective>
Expand clarity-tdd.md reference file with collaborative test generation workflow, Vitest patterns, and coverage analysis.

Purpose: Provide comprehensive guidance for the TDD phase (Phase 2) including collaborative scenario approval, test writing patterns, and coverage gate preparation.

Output: Enhanced clarity-tdd.md (~180-200 lines) with:
- Collaborative TDD workflow (propose → approve → write)
- Vitest + Clarinet SDK patterns
- Coverage configuration and analysis
- Soft TDD enforcement approach
</objective>

<execution_context>
@/Users/kenny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kenny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context
@.planning/phases/04-tdd-workflow-contract-implementation/04-CONTEXT.md
@.planning/phases/04-tdd-workflow-contract-implementation/04-RESEARCH.md

# Current file to enhance
@skills/stacks-dev/references/clarity-tdd.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite clarity-tdd.md with comprehensive TDD workflow</name>
  <files>skills/stacks-dev/references/clarity-tdd.md</files>
  <action>
Rewrite clarity-tdd.md to include the following sections (keep under 200 lines):

## Collaborative TDD Workflow
- Explain the propose → approve → write cycle (from CONTEXT.md)
- Show scenario presentation format with categories: happy path, edge cases, error handling
- Note that tests are batch-written after approval, not incremental per function

## Soft TDD Enforcement
- Explain soft redirect behavior (from CONTEXT.md): redirect when user writes contract before tests
- Track and display TDD compliance: "TDD: ✓ followed" or "TDD: ⚠ skipped"
- No blocking or forced acknowledgment - just proceed if user insists

## Vitest + Clarinet SDK Setup
- Configuration example from RESEARCH.md Pattern 4:
  ```javascript
  import { defineConfig } from 'vitest/config';
  import { vitestSetupFilePath } from "@hirosystems/clarinet-sdk/vitest";

  export default defineConfig({
    test: {
      environment: "node",
      globals: true,
      setupFiles: [vitestSetupFilePath],
      coverage: {
        provider: 'v8',
        reporter: ['text', 'html', 'lcov'],
        thresholds: { lines: 90, functions: 90, branches: 90, statements: 90 }
      }
    }
  });
  ```
- Package.json scripts: test, test:coverage, test:watch

## Test Patterns
- Keep existing patterns but update to use correct imports
- Add multi-user scenario pattern from RESEARCH.md Pattern 3
- Reference custom matchers: toBeOk, toBeErr, toBeUint, toBeSome, toBeNone

## Coverage Analysis
- CRITICAL: Use `vitest run --coverage` NOT deprecated `clarinet test --coverage`
- Show coverage report format
- Explain threshold enforcement
- Auto-suggest tests for uncovered code (from CONTEXT.md)

## External References
- Link to Clarinet SDK testing docs: https://docs.stacks.co/clarinet/testing-with-clarinet-sdk
- Link to Vitest coverage: https://vitest.dev/guide/coverage
- Link to Clarity Book Chapter 7 testing: https://book.clarity-lang.org/ch07-04-testing-your-contract.html
  </action>
  <verify>
File exists, has expected sections, under 200 lines:
```bash
wc -l skills/stacks-dev/references/clarity-tdd.md
grep -c "Collaborative" skills/stacks-dev/references/clarity-tdd.md
grep -c "vitest" skills/stacks-dev/references/clarity-tdd.md
grep -c "toBeOk" skills/stacks-dev/references/clarity-tdd.md
```
  </verify>
  <done>
clarity-tdd.md contains collaborative workflow, Vitest patterns, coverage configuration, and soft TDD enforcement - ready to support SKILL.md Phase 2.
  </done>
</task>

</tasks>

<verification>
After task completion, verify:
1. File exists: `ls skills/stacks-dev/references/clarity-tdd.md`
2. Line count: `wc -l skills/stacks-dev/references/clarity-tdd.md` (target: 180-200 lines)
3. Contains key sections: Collaborative, Vitest, Coverage, External References
4. No deprecated patterns (no `clarinet test --coverage` as primary approach)
5. Matches research patterns from 04-RESEARCH.md
</verification>

<success_criteria>
1. clarity-tdd.md contains Collaborative TDD Workflow section with propose → approve → write
2. clarity-tdd.md contains Soft TDD Enforcement section with tracking display format
3. clarity-tdd.md contains Vitest configuration with 90% coverage thresholds
4. clarity-tdd.md uses `vitest run --coverage` (not deprecated `clarinet test --coverage`)
5. clarity-tdd.md links to authoritative sources (Stacks docs, Vitest, Clarity Book)
6. File is under 200 lines (progressive disclosure)
</success_criteria>

<output>
After completion, create `.planning/phases/04-tdd-workflow-contract-implementation/04-01-SUMMARY.md`
</output>
